# -------- å»ºæ§‹éšæ®µ --------
FROM golang:1.24-alpine AS builder

ENV CGO_ENABLED=0 \
    GOOS=linux \
    GOARCH=amd64

WORKDIR /app

# è¤‡è£½ go.mod/go.sum ä¸¦å®‰è£ä¾è³´
COPY go.mod go.sum ./
RUN go mod download

# è¤‡è£½éœ€è¦çš„ç¨‹å¼ç¢¼
COPY api/batch ./api/batch
COPY common ./common

# ç·¨è­¯ main.goï¼ˆğŸ”¥ é€™æ˜¯ä½ çš„ batch å…¥å£é»ï¼‰
RUN go build -o batch ./api/batch/cmd/main.go

# -------- åŸ·è¡Œéšæ®µ --------
FROM gcr.io/distroless/static-debian12

WORKDIR /

# è¤‡è£½åŸ·è¡Œæª”
COPY --from=builder /app/batch .

EXPOSE 8080

# å•Ÿå‹• batch serverï¼ˆå¯ç”± Cloud Run æˆ– Cloud Scheduler å‘¼å«ï¼‰
ENTRYPOINT ["/batch"]